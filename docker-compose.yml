version: '2.1'
services:
  postgres-database:
    container_name: postgres-case-it
    image: eu.gcr.io/ons-rasrmbs-management/postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
    - "15432:5432"
  redis:
    container_name: redis-case-it
    image: redis:3.2.9
    ports:
    - "17379:6379"
  pubsub-emulator:
    container_name: pubsub-emulator-it
    image: eu.gcr.io/ons-rasrmbs-management/pubsub-emulator
    ports:
    - "18681:8681"
    environment:
    - PUBSUB_PROJECT1=test,test_case_creation_topic:test_case_creation_subscription
  collectionexercise:
    container_name: collex-case-it
    external_links:
    - postgres-case-it
    - redis-case-it
    image: eu.gcr.io/ons-rasrmbs-management/collection-exercise
    environment:
    - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-case-it:5432/postgres?sslmode=disable
    - SPRING_DATASOURCE_USERNAME=postgres
    - SPRING_DATASOURCE_PASSWORD=postgres
    - SPRING_LIQUIBASE_URL=jdbc:postgresql://postgres-case-it:5432/postgres
    - SPRING_LIQUIBASE_USER=postgres
    - SPRING_LIQUIBASE_PASSWORD=postgres
    - REDISSON_CONFIG_ADDRESS=redis-case-it:6379
    - DATA_GRID_ADDRESS=redis-case-it:6379
    - SURVEY_SVC_CONNECTION_CONFIG_HOST=survey-case-it
    - SURVEY_SVC_CONNECTION_CONFIG_PORT=8080
    - ACTION_SVC_CONNECTION_CONFIG_HOST=action-case-it
    - ACTION_SVC_CONNECTION_CONFIG_PORT=8151
    - PUBSUB_EMULATOR_HOST=pubsub-emulator-it:8681
    ports:
    - "38145:8145"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8145/actuator/info"]
      interval: 30s
      timeout: 10s
      retries: 10

  survey:
    container_name: survey-case-it
    image: eu.gcr.io/ons-rasrmbs-management/survey
    external_links:
    - postgres-case-it
    environment:
    - DATABASE_URL=postgres://postgres:postgres@postgres-case-it:5432/postgres?sslmode=disable
    - security_user_name=admin
    - security_user_password=secret
    ports:
    - "38080:8080"